metadata:
  id: "compression.memory_extraction"
  name: "Memory Extraction (Three-Level)"
  description: "Extract memories from session context using L0/L1/L2 three-level structure"
  version: "5.0.0"
  language: "en"
  category: "compression"

variables:
  - name: "summary"
    type: "string"
    description: "Session history summary"
    required: false
    default: ""
  - name: "recent_messages"
    type: "string"
    description: "Recent conversation content"
    required: true
  - name: "user"
    type: "string"
    description: "User identifier"
    required: true
  - name: "feedback"
    type: "string"
    description: "User feedback"
    required: false
    default: ""
  - name: "output_language"
    type: "string"
    description: "Target language for extracted memory fields (abstract, overview, content)"
    required: false
    default: "auto"

template: |
  Analyze the following session context and extract memories worth long-term preservation.

  User: {{ user }}

  Target Output Language: {{ output_language }} ("auto" means detect from recent messages)

  {% if summary %}
  ## Session History Summary
  {{ summary }}
  {% endif %}

  ## Recent Conversation
  {{ recent_messages }}

  {% if feedback %}
  ## User Feedback
  {{ feedback }}
  {% endif %}

  # Memory Extraction Criteria

  ## What is worth remembering?
  - ✅ **Personalized information**: Information specific to this user, not general domain knowledge
  - ✅ **Long-term validity**: Information that will still be useful in future sessions
  - ✅ **Specific and clear**: Has concrete details, not vague generalizations

  ## What is NOT worth remembering?
  - ❌ **General knowledge**: "Personalized service is core to romantic vacations" (domain knowledge, not personalized memory)
  - ❌ **Temporary information**: One-time questions or conversations
  - ❌ **Vague information**: "User has questions about a feature" (no specific details)

  # Memory Classification

  ## Core Decision Logic

  When choosing a category, first ask yourself: What is this information mainly about?

  | Question | Answer | Category |
  |----------|--------|----------|
  | Who is the user? | Identity, attributes | profile |
  | What does the user prefer? | Preferences, habits | preferences |
  | What is this thing? | Person, project, organization | entities |
  | What happened? | Decision, milestone | events |
  | How was it solved? | Problem + solution | cases |
  | What is the process? | Reusable steps | patterns |

  ## Precise Definition of Each Category

  **profile** - User identity (static attributes)
  - Core: Describes "who the user is"
  - Characteristics: Relatively stable personal attributes
  - Test: Can it start with "User is..."

  **preferences** - User preferences (tendency choices)
  - Core: Describes "user tends to/habits"
  - Characteristics: Changeable choices, styles
  - Test: Can it be described as "User prefers/likes..."

  **entities** - Entities (continuously existing nouns)
  - Core: Describes "current state of something"
  - Characteristics: Entities with lifecycle (person/project/organization)
  - Test: Can it be described as "XXX's state is..."

  **events** - Events (things that happened)
  - Core: Describes "what happened"
  - Characteristics: Has time point, is action completion
  - Test: Can it be described as "XXX did/completed/happened..."

  **cases** - Cases (problem + solution)
  - Core: Describes "how a specific problem was solved"
  - Characteristics: One-time scenario, specific solution
  - Test: Does it contain "problem → solution" structure

  **patterns** - Patterns (reusable processes)
  - Core: Describes "what process to follow in what situation"
  - Characteristics: Reusable across multiple scenarios
  - Test: Can it be used for "similar situations"

  ## Common Confusion Clarification

  - "Plan to do X" → events (action, not entity)
  - "Project X status: Y" → entities (describes entity)
  - "User prefers X" → preferences (not profile)
  - "Encountered problem A, used solution B" → cases (not events)
  - "General process for handling certain problems" → patterns (not cases)

  # Three-Level Structure

  Each memory contains three levels, each serving a purpose:

  **abstract (L0)**: Index layer, plain text one-liner
  - Merge types (preferences/entities/profile/patterns): `[Merge key]: [Description]`
    - preferences: `Python code style: No type hints, concise and direct`
    - entities: `OpenViking project: AI Agent long-term memory management system`
    - profile: `User basic info: AI development engineer, 3 years experience`
    - patterns: `Teaching topic handling: Outline→Plan→Generate PPT`
  - Independent types (events/cases): Specific description
    - events: `Decided to refactor memory system: Simplify to 5 categories`
    - cases: `Band not recognized → Request member/album/style details`

  **overview (L1)**: Structured summary layer, organized with Markdown headings
  - preferences: `## Preference Domain` / `## Specific Preferences`
  - entities: `## Basic Info` / `## Core Attributes`
  - events: `## Decision Content` / `## Reason` / `## Result`
  - cases: `## Problem` / `## Solution`

  **content (L2)**: Detailed expansion layer, free Markdown, includes background, timeline, complete narrative

  # Few-shot Examples

  ## profile Example (Merge type)
  ✅ **Good**:
  ```json
  {
    "category": "profile",
    "abstract": "User basic info: AI development engineer, 3 years LLM application experience",
    "overview": "## Background Info\\n- Occupation: AI development engineer\\n- Experience: 3 years LLM application development\\n- Tech stack: Python, LangChain",
    "content": "User is an AI development engineer with 3 years of LLM application development experience, mainly using Python and LangChain tech stack. Communication style is concise and direct, prefers efficient code implementation."
  }
  ```
  ❌ **Bad**: abstract says "User info" (too vague, cannot merge)

  ## preferences Example (Merge type)
  ✅ **Good**:
  ```json
  {
    "category": "preferences",
    "abstract": "Python code style: No type hints, concise and direct",
    "overview": "## Preference Domain\\n- **Language**: Python\\n- **Topic**: Code style\\n\\n## Specific Preferences\\n- No type hints, considers them too verbose\\n- Function comments limited to 1-2 lines\\n- Prioritize concise and direct, avoid over-engineering",
    "content": "User has shown clear preferences for Python code style in multiple conversations: dislikes using type hints, considers them redundant; requires concise function comments, limited to 1-2 lines; prefers direct implementation, avoids excessive fallbacks and over-engineering."
  }
  ```
  ❌ **Bad**: abstract says "Code preferences" (too general) or "No type hints" (too specific, cannot merge other style preferences)

  ## entities Example (Merge type)
  ✅ **Good**:
  ```json
  {
    "category": "entities",
    "abstract": "OpenViking project: AI Agent long-term memory management system",
    "overview": "## Basic Info\\n- **Type**: Project\\n- **Status**: Active development\\n- **Tech stack**: Python, AGFS\\n\\n## Core Features\\n- Memory extraction (MemoryExtractor)\\n- Memory deduplication (MemoryDeduplicator)\\n- Memory retrieval (vector search)",
    "content": "OpenViking is an AI Agent long-term memory management system the user is developing. The project uses Python and AGFS tech stack, core features include memory extraction, deduplication, and retrieval. Currently in active development, goal is to build Claude-like long-term memory capabilities."
  }
  ```

  ## events Example (Independent type)
  ✅ **Good**:
  ```json
  {
    "category": "events",
    "abstract": "Decided to refactor memory system: From 6 categories to 5 categories",
    "overview": "## Decision Content\\nRefactor memory system classification\\n\\n## Reason\\nOriginal 6 categories had blurry boundaries between states/lessons/insights\\n\\n## Result\\nSimplified to profile/preferences/entities/events/cases/patterns",
    "content": "During memory system design discussion, found that the original 6 categories (profile/states/lessons/insights/cases/patterns) had blurry boundaries. Especially states, lessons, insights often overlapped and were hard to distinguish. Decided to refactor to 5 categories, removing these three to make classification boundaries clearer."
  }
  ```

  ## cases Example (Independent type)
  ✅ **Good**:
  ```json
  {
    "category": "cases",
    "abstract": "Band not recognized → Request member/album/style details",
    "overview": "## Problem\\nUser feedback that a band cannot be recognized by system\\n\\n## Solution\\nRequest user to provide more details:\\n- Band member names\\n- Representative albums\\n- Music style",
    "content": "User feedback mentioned a band that the system could not recognize. Solution is to request user to provide more identification details: band member names, representative album names, music style, etc. This information can improve recognition accuracy."
  }
  ```

  ## patterns Example (Merge type)
  ✅ **Good**:
  ```json
  {
    "category": "patterns",
    "abstract": "Teaching topic handling: Outline→Plan→Generate PPT→Refine content",
    "overview": "## Trigger Condition\\nUser requests teaching content for a topic\\n\\n## Process Flow\\n1. List topic outline\\n2. Create detailed plan\\n3. Generate PPT framework\\n4. Refine each section",
    "content": "When user requests teaching content for a topic, use a four-step process: first list the topic outline to understand overall structure; then create a detailed learning plan; next generate PPT framework; finally refine specific content for each section. This process ensures content is systematic and complete."
  }
  ```

  # Output Format

  Please return JSON format:
  {
    "memories": [
      {
        "category": "profile|preferences|entities|events|cases|patterns",
        "abstract": "Merge types use `[Merge key]: [Description]`, independent types use specific description",
        "overview": "Structured Markdown, use different heading templates by category",
        "content": "Free Markdown, complete narrative"
      }
    ]
  }

  Notes:
  - The values of "abstract", "overview", and "content" MUST be written in {{ output_language }} (if output_language is "auto", use the dominant language in recent_messages).
  - Only extract truly valuable personalized information
  - If nothing worth recording, return {"memories": []}
  - Preferences should be aggregated by topic, similar preferences should be merged into one memory

llm_config:
  temperature: 0.0

